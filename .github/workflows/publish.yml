name: Publish to npm

on:
  push:
    branches:
      - main
    paths:
      - 'package.json'  # åªåœ¨ package.json å˜åŒ–æ—¶è§¦å‘

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'å¼ºåˆ¶å‘å¸ƒï¼ˆè·³è¿‡ç‰ˆæœ¬æ£€æµ‹ï¼‰'
        required: false
        type: boolean
        default: false

# è®¾ç½®æƒé™ - provenance éœ€è¦ id-token: write
permissions:
  contents: read
  id-token: write

# é˜²æ­¢å¹¶å‘å‘å¸ƒ
concurrency:
  group: "npm-publish"
  cancel-in-progress: false

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
      new_version: ${{ steps.check.outputs.version }}
      is_beta: ${{ steps.check.outputs.is_beta }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # éœ€è¦èŽ·å–ä¸Šä¸€ä¸ª commit æ¥æ¯”è¾ƒ

      - name: Check version change
        id: check
        run: |
          # èŽ·å–å½“å‰ç‰ˆæœ¬
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦ä¸º beta ç‰ˆæœ¬
          if [[ "$CURRENT_VERSION" == *"beta"* ]]; then
            echo "is_beta=true" >> $GITHUB_OUTPUT
            echo "This is a beta version"
          else
            echo "is_beta=false" >> $GITHUB_OUTPUT
            echo "This is a release version"
          fi
          
          # æ£€æŸ¥æ˜¯å¦å¼ºåˆ¶å‘å¸ƒ
          FORCE_PUBLISH="${{ github.event.inputs.force_publish }}"
          if [ "$FORCE_PUBLISH" == "true" ]; then
            echo "Force publish enabled, skipping version check"
            echo "should_publish=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # èŽ·å–ä¸Šä¸€ä¸ª commit çš„ç‰ˆæœ¬
          git show HEAD~1:package.json > /tmp/old-package.json 2>/dev/null || echo '{"version":"0.0.0"}' > /tmp/old-package.json
          OLD_VERSION=$(node -p "require('/tmp/old-package.json').version")
          echo "Previous version: $OLD_VERSION"
          
          # æ¯”è¾ƒç‰ˆæœ¬
          if [ "$CURRENT_VERSION" != "$OLD_VERSION" ]; then
            echo "Version changed from $OLD_VERSION to $CURRENT_VERSION"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          else
            echo "Version unchanged"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          fi

  publish-beta:
    needs: check-version
    if: needs.check-version.outputs.should_publish == 'true' && needs.check-version.outputs.is_beta == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # è‡ªåŠ¨ä»Ž package.json çš„ packageManager å­—æ®µè¯»å–ç‰ˆæœ¬

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm run build
        env:
          NODE_ENV: production

      - name: Publish Beta to npm
        run: npm publish --tag beta --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸ§ª Beta Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.check-version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Install:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npm install advanced-ele-ui@beta" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  publish-release:
    needs: check-version
    if: needs.check-version.outputs.should_publish == 'true' && needs.check-version.outputs.is_beta == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # è‡ªåŠ¨ä»Ž package.json çš„ packageManager å­—æ®µè¯»å–ç‰ˆæœ¬

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm run build
        env:
          NODE_ENV: production

      - name: Publish Release to npm
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸš€ Release Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.check-version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Install:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npm install advanced-ele-ui@${{ needs.check-version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
